## 实现计划

### 总体原则
- **先打基础**：网关、模型接入、数据与权限基座先行。
- **按服务拆分落地**：以微服务拆分为主线推进。
- **可观测与安全前置**：审计、追踪、脱敏、配额纳入第一阶段。

### 阶段 0：项目基座（1-2 周）
**目标**：搭建工程与运行基座，保证后续服务可独立交付。
- Step 1：建立仓库结构与基础工程模板（服务目录/共享库/部署模板）
  - 测试：能从模板一键创建新服务，启动后返回健康检查（/healthz）。
- Step 2：CI/CD 与镜像构建流水线
  - 测试：Push 后触发流水线，生成版本化镜像并可拉取运行。
- Step 3：配置与密钥管理规范（环境变量/配置文件/密钥占位）
  - 测试：在不改代码的情况下切换环境（dev/staging）。
- Step 4：链路追踪与日志规范（OpenTelemetry 预留）
  - 测试：请求链路可在日志中关联 trace_id。
- Step 5：租户/组织/项目数据模型定义
  - 测试：数据库中可创建租户/项目，并与用户绑定查询。
**产出**：可运行的基础工程骨架与部署模板。

### 阶段 1：核心服务 MVP（2-4 周）
**目标**：跑通最小闭环（调用模型 -> RAG -> 工具 -> 返回结果）。
- Step 6：API Gateway（鉴权、租户识别、限流、基础计量）
  - 测试：携带有效/无效 JWT 的请求分别通过/拒绝；租户ID写入上下文。
- Step 7：Model Gateway（统一模型接口、基础路由、失败回退）
  - 测试：同一请求可切换不同模型；当主模型失败时自动回退。
- Step 8：Agent Core（单 Agent 流程 + 工具调用）
  - 测试：执行一个含工具调用的任务并返回结构化结果。
- Step 9：Knowledge Engine（文档上传、解析、向量化、检索）
  - 测试：上传文档后可检索出 Top-K 相关片段。
- Step 10：Sandbox Runner（Docker 执行 + 资源限制）
  - 测试：在 Docker 中执行脚本并返回 stdout；超时任务被终止。
**产出**：可用于 Demo 的端到端 Agent（单租户+基础多租户配置）。

### 阶段 2：可用性与多租户完善（3-5 周）
**目标**：提升稳定性与多租户隔离能力。
- Step 11：多租户数据隔离（命名空间/分区/ACL）
  - 测试：跨租户检索与读取被拒绝。
- Step 12：运行时隔离与配额（并发/速率/资源池）
  - 测试：超过配额的请求被限流，错误码清晰。
- Step 13：计费与用量统计（Token/成本/账单事件）
  - 测试：每次请求生成用量事件并可聚合到租户报表。
- Step 14：异步任务中心（长任务/重试/状态查询）
  - 测试：提交长任务返回 task_id，可查询进度与结果。
- Step 15：可观测与审计
  - 测试：关键操作产生审计记录；链路可回放。
**产出**：可生产试点版本（多租户隔离+稳定性保障）。

### 阶段 3：企业级能力（4-6 周）
**目标**：治理、风控、审核与规模化运维。
- Step 16：安全治理（输入/输出护栏）
  - 测试：命中敏感策略的输入/输出被拦截并记录。
- Step 17：敏感工具审批流
  - 测试：敏感工具调用需要审批才能执行。
- Step 18：合规审计与数据保留
  - 测试：日志按保留周期自动清理；脱敏规则生效。
- Step 19：管理后台（租户/知识库/Prompt/权限）
  - 测试：管理员可完成租户与权限配置并立即生效。
- Step 20：高可用与灰度发布
  - 测试：单实例故障不影响服务；灰度流量可控。
**产出**：企业级可运营版本（合规与治理完善）。

### 验收与交付标准
- 端到端链路稳定运行，核心服务可独立扩缩容
- 多租户隔离在数据/运行时/计费上可验证
- 关键路径可观测、可审计、可回放

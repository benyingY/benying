# 企业级 Agent 平台架构蓝图

本文档是平台整体架构与能力分层的详细说明，供架构设计、平台建设、治理与安全协作时对齐口径。

## 1. 总体分层
User/业务入口 → Agent 构建与发布（Control Plane） → Agent 运行时（Data Plane） → 模型/知识/工具（Capabilities） → 治理&可观测&成本（Governance）

---

## 2. 入口与产品层（给“全公司用”的统一门面）
- 统一入口与分发：Web Chat、API、IM/飞书/Slack Bot、工单/内部系统嵌入式插件
- 应用目录（Agent Store）：按部门/业务线分组、搜索、权限申请、版本说明、使用文档
- 会话与工单化：会话历史、引用证据、导出、分享、转交/升级（给人工）

---

## 3. Agent 构建层（Studio/IDE：让开发者和业务方都能做）
- Agent 配置与版本管理：Prompt/指令、工具权限、知识源选择、模型路由策略、版本/回滚
- 工作流编排器：LangGraph（Agent 认知图）+ Temporal（业务长流程状态机，含重试、补偿、超时、幂等）
- 调试与沙箱：单步调试、变量观测、trace 回放、仿真输入、mock 工具
- Prompt/Policy 仓库：模板化、差分对比、审批流、灰度发布（像“代码评审”一样管起来）
- SDK/脚手架：Python/TS SDK、内部规范封装、最佳实践模板（RAG/工具调用/审批流）

---

## 4. 运行时（核心！决定“能不能规模化稳定跑”）
- 编排执行引擎（Orchestrator Runtime）：支持多 Agent / 多步骤 / 多模型调用；任务队列、并发控制、超时重试、幂等键、断点续跑（长任务必备）
- 会话与状态管理（State/Memory Runtime）：短期会话状态、结构化状态（JSON schema）、长期记忆（可选、强治理）
- 工具调用执行器（Tool Executor）：Go 执行器；通过 gRPC + OpenAPI 3.1 Schema 与 Python Agent 交互；支持速率限制与网络边界
- Human-in-the-loop：基于 Temporal Signals/Queries 的审批节点（如“发起变更/写库/发公告/发邮件”）；人工确认、协作、SOP 挂载

### 4.1 关键边界约束（必须统一）
- Temporal 负责粗粒度业务流程编排（接单、审批、写回业务系统）
- LangGraph 负责细粒度 Agent 推理图，作为 Temporal Activity 运行
- LangGraph 中间状态仅在单次 Activity 生命周期内维护，不与 Temporal 双写
- Tool 执行分级隔离：Trusted Tools 进程内执行；Untrusted Tools 强制进入 gVisor/Kata 沙箱

---

## 5. 能力层（Capabilities：模型、知识、工具三件套）

### 5.1 模型接入与路由（对接推理平台）
- Model Gateway：统一调用接口（多厂商/多版本/流式/重试/限流）
- 模型路由策略：大小模型切换、按任务类型路由、降级（不可用时 fallback）
- 上下文与缓存：Token 预算、摘要、KV/响应缓存（视场景）

### 5.2 知识与检索（Enterprise RAG）
- 数据源连接器：Wiki/文档库/代码库/工单/指标平台/DB（注意权限继承）
- 索引与向量库：切分、去重、版本、增量更新、TTL；默认 PostgreSQL + pgvector，并按租户/业务线分区
- 检索链路：Query rewrite、Hybrid Search、Rerank、引用与证据输出
- 权限与审计：Embedding 入库时同步 ACL Metadata（用户组/部门/租户）；检索时先做权限 Pre-Filtering 再向量召回

### 5.3 工具与系统集成（Tool Registry）
- 工具注册中心：工具元数据、Owner、权限域、SLA、成本、风险等级
- 连接器/适配器层：对接内部 RPC/API、DB、消息、CI/CD、CMDB、监控
- Secret 管理：密钥托管、临时凭证、最小权限、轮转

---

## 6. 安全、合规与治理（企业级“必选项”）
- 身份与权限（SSO/RBAC/ABAC）：按用户/部门/租户/数据域授权；支持“权限申请与审批”
- 数据安全：脱敏、PII/敏感字段识别、数据出域控制、加密与留痕
- 内容安全与防护：提示注入防护、越权工具调用拦截、输出合规策略（Policy-as-Code）
- 变更治理：Prompt/工具/知识源变更审批、灰度、回滚、一键冻结
- 审计与取证：谁在何时用哪个 Agent 调用了哪个工具、读了哪些数据、产出什么结果

---

## 7. 可观测性与稳定性（让平台“可运营”）
- 全链路 Trace：一步一 trace（模型调用、检索、工具调用、审批节点）
- 指标体系：成功率、端到端耗时、步骤耗时拆分、TTFT、token、成本、工具错误率
- 日志与样本：可回放样本、错误样本集、红队样本、线上问题定位
- SRE 能力：限流熔断、隔离舱（故障域隔离）、降级策略、告警与值班联动

---

## 8. 评测与持续改进（决定“越用越好”还是“越用越乱”）
- 离线评测（Eval Harness）：任务成功率、引用正确性、工具调用正确性、幻觉率
- 在线反馈闭环：👍👎、原因标签、人工改写、回流训练/提示词迭代
- A/B 与灰度实验：策略/提示词/模型路由的实验平台
- 质量门禁：发布前必须过评测阈值（像 CI 一样）；每个业务 Agent 需维护 20-50 条 Golden Dataset

---

## 9. 成本与配额（FinOps：全公司通用必须有）
- 用量计量：token、请求数、检索次数、工具调用次数、外部 API 成本
- 配额与预算：按租户/部门/应用限额；超过预算自动降级/停用/审批
- 成本归因：到 Agent / 场景 / 部门维度的账单与报表；覆盖 token、检索、工具调用与向量检索 CPU 成本分摊

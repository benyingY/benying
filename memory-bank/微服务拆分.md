### 微服务拆分方案 (Service Architecture)

开发一个完整的平台，不建议做成一个巨大的单体应用（Monolith）。由于 RAG 解析消耗 CPU，模型推理消耗 GPU，Agent 逻辑消耗 IO，**根据资源密集型不同进行拆分**是最佳策略。

建议拆分为 **7 个核心服务**：

#### 1. API Gateway Service (BFF / 网关层)
*   **技术栈**：APISIX / Kong（必要时增加轻量 BFF，推荐 Go）
*   **职责**：
    *   统一对外暴露接口 (RESTful / WebSocket)。
    *   **鉴权 (Auth)**：验证 JWT，管理用户权限。
    *   **限流与计费**：计算 Token 消耗，拦截欠费用户。
    *   **协议转换**：将 HTTP 请求转换为内部 RPC 或 消息队列消息。

#### 2. Model Gateway Service (模型网关)
*   **技术栈**：LiteLLM Proxy / 自研路由服务（Python 或 Go）
*   **职责**：
    *   **统一模型接口**：屏蔽 OpenAI/本地模型差异。
    *   **模型路由**：按任务难度、成本、延迟选择模型。
    *   **配额与降级**：租户级限额、失败回退与熔断。
    *   **用量统计**：输出 Token/成本指标供计费使用。

#### 3. Agent Core Service (大脑 / 核心业务)
*   **技术栈**：Python (FastAPI + LangGraph)
*   **职责**：
    *   **编排逻辑**：加载 Prompt，运行 ReAct/CoT 循环。
    *   **工具分发**：决定调用哪个工具。
    *   **状态管理**：从 Redis 读取/保存当前对话上下文。
    *   *注：这是最核心的服务，业务逻辑都在这。*

#### 4. Knowledge Engine Service (RAG 引擎)
*   **技术栈**：Python (FastAPI + Unstructured + Qdrant客户端)
*   **职责**：
    *   **ETL 流水线**：接收用户上传的文件 -> 解析 -> 清洗 -> 切片 (Chunking)。
    *   **向量化 (Embedding)**：调用 Embedding 模型生成向量。
    *   **检索 (Retrieval)**：对接向量数据库，执行混合检索。
    *   *理由：文件解析非常消耗 CPU，且容易阻塞线程，必须与 Agent Core 隔离。*

#### 5. Sandbox Runner Service (沙箱执行器)
*   **技术栈**：Go + Docker API / Kubernetes Jobs
*   **职责**：
    *   管理临时的 Docker 容器池。
    *   接收 Python/SQL 代码片段 -> 在容器内执行 -> 捕获标准输出(stdout)和错误 -> 返回结果。
    *   负责安全清理和超时强制杀进程。

#### 6. Async Worker Service (异步任务中心)
*   **技术栈**：Python (Celery Workers)
*   **职责**：
    *   执行耗时极长的任务（如：生成长篇研报、批量处理数据）。
    *   重试机制（LLM 经常超时或报错，需要自动重试）。

#### 7. Management Service (控制台后端)
*   **技术栈**：Go / Python
*   **职责**：
    *   主要负责 CRUD 操作，不涉及 AI 逻辑。
    *   Prompt 模板管理、知识库文件管理、用户管理、日志查询。

---

### 架构数据流向示意

1.  **用户** 在前端发送 "帮我分析财报"。
2.  请求 -> **API Gateway** (鉴权)。
3.  Gateway -> **Agent Core** (启动一个 Agent 实例)。
4.  Agent Core -> **Knowledge Service** (请求检索财报文档)。
5.  Agent Core -> **Model Gateway** -> **LLM** (根据检索内容生成代码)。
6.  Agent Core -> **Sandbox Service** (执行 Python 代码画图)。
7.  Agent Core -> **Redis** (更新对话状态)。
8.  Agent Core -> **API Gateway** (WebSocket 流式返回结果给用户)。
9.  全过程日志 -> 异步写入 **LangFuse** (LLMOps)。
